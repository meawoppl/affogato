name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release info
        id: release
        run: |
          # Get tag from release event or latest
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG=$(gh release view --json tagName -q .tagName)
          fi

          # Extract commit count from tag (r123 -> 123)
          COMMIT_COUNT="${TAG#r}"
          SEMVER="0.${COMMIT_COUNT}.0"

          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "semver=${SEMVER}" >> $GITHUB_OUTPUT
          echo "Tag: ${TAG}, Semver: ${SEMVER}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release assets and compute SHA256
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          BASE_URL="https://github.com/meawoppl/affogato/releases/download/${TAG}"

          mkdir -p /tmp/assets
          cd /tmp/assets

          curl -sL "${BASE_URL}/affogato-x86_64-apple-darwin.tar.gz" -o macos-intel.tar.gz
          curl -sL "${BASE_URL}/affogato-aarch64-apple-darwin.tar.gz" -o macos-arm.tar.gz
          curl -sL "${BASE_URL}/affogato-x86_64-unknown-linux-gnu.tar.gz" -o linux-intel.tar.gz
          curl -sL "${BASE_URL}/affogato-aarch64-unknown-linux-gnu.tar.gz" -o linux-arm.tar.gz

          echo "SHA_MACOS_INTEL=$(sha256sum macos-intel.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "SHA_MACOS_ARM=$(sha256sum macos-arm.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "SHA_LINUX_INTEL=$(sha256sum linux-intel.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV
          echo "SHA_LINUX_ARM=$(sha256sum linux-arm.tar.gz | cut -d' ' -f1)" >> $GITHUB_ENV

      - name: Update formula
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          SEMVER="${{ steps.release.outputs.semver }}"

          mkdir -p homebrew
          cat > homebrew/affogato.rb << EOF
          class Affogato < Formula
            desc "ESP32-S2 + ICE40 FPGA development tool"
            homepage "https://github.com/meawoppl/affogato"
            version "${SEMVER}"
            license "MIT"

            on_macos do
              on_intel do
                url "https://github.com/meawoppl/affogato/releases/download/${TAG}/affogato-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_INTEL}"
              end
              on_arm do
                url "https://github.com/meawoppl/affogato/releases/download/${TAG}/affogato-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_MACOS_ARM}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/meawoppl/affogato/releases/download/${TAG}/affogato-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_INTEL}"
              end
              on_arm do
                url "https://github.com/meawoppl/affogato/releases/download/${TAG}/affogato-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_LINUX_ARM}"
              end
            end

            depends_on "docker" => :recommended

            def install
              bin.install "affogato"
            end

            test do
              system "#{bin}/affogato", "--version"
            end
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add homebrew/affogato.rb
          git diff --staged --quiet || git commit -m "Update Homebrew formula to ${{ steps.release.outputs.tag }}"
          git push
